define("ops:widget/online/list.jsx",function(e,t,a){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var r=e("react"),n=s(r),l=e("antd"),o=e("reqwest"),i=s(o),u=(e("react-router"),e("ops:static/js/utils/utils.js")),d=s(u),c=e("ops:widget/online/errno.js"),h=s(c),m=(e("react-dom"),l.Select.Option),f=n["default"].createClass({displayName:"Filter",componentWillReceiveProps:function(){this.props.requestData(this.requestData())},componentDidMount:function(){this.props.requestData(this.requestData())},getInitialState:function(){var e=(new Date).getTime();return{show:{showDate:!1,showSelect:!1,showExecute:!1,showAll:!1,showCreate:!1,showStatus:!1},starttime:e,endtime:e,choose:"showAll",select:"all",status:"all",mine:"mine"}},requestData:function(){var e=(this.props.search,this),t=e.refs.man.refs.input.value,a={},s=this.state.choose;return"showSelect"==s?a.type=this.state.select:"showCreate"==s?(a.type="createUser",a.username=t):"showExecute"==s?(a.type="operationUser",a.username=t):"showDate"==s?(a.type="time",a.time_section=this.state.starttime+","+this.state.endtime):"showStatus"==s?(a.type="menuStatus","all"==this.state.status?a.type="all":a.status=this.state.status):a.type="showAll"==s?"all":this.state.select,a},render:function(){var e=this,t=this.state.show,a=function(e){return e&&e.getTime()>Date.now()};return n["default"].createElement("div",{className:"list"},n["default"].createElement(l.Row,null,n["default"].createElement(l.Col,{span:"24"},n["default"].createElement(l.Col,{span:"3"},n["default"].createElement(l.Button,{type:"ghost",onClick:function(){e.request("mine")}},"本人订单")),n["default"].createElement(l.Col,{span:"3"},n["default"].createElement(l.Select,{defaultValue:"showAll",onSelect:this.chooseSelect,style:{width:120}},n["default"].createElement(m,{value:"showAll"},"全部"),n["default"].createElement(m,{value:"showCreate"},"创建者"),n["default"].createElement(m,{value:"showExecute"},"执行者"),n["default"].createElement(m,{value:"showDate"},"时间段"),n["default"].createElement(m,{value:"showSelect"},"类型"),n["default"].createElement(m,{value:"showStatus"},"状态"))),n["default"].createElement(l.Col,{span:"5",className:t.showCreate||t.showExecute?"show":"hidden"},n["default"].createElement(l.Col,{span:"22"},n["default"].createElement(l.Input,{id:"defaultInput",placeholder:"eg:(xxx_iwm)",ref:"man"}))),n["default"].createElement(l.Col,{span:"5",className:t.showSelect?"show":"hidden"},n["default"].createElement(l.Col,{span:"22"},n["default"].createElement(l.Select,{defaultValue:"all",style:{width:120},onChange:this.onSelectChange},n["default"].createElement(m,{value:"all"},"全部"),n["default"].createElement(m,{value:"online"},"上线单"),n["default"].createElement(m,{value:"rollback"},"回滚单")))),n["default"].createElement(l.Col,{span:"5",className:t.showStatus?"show":"hidden"},n["default"].createElement(l.Col,{span:"22"},n["default"].createElement(l.Select,{defaultValue:"all",style:{width:120},onChange:this.onStatusChange},n["default"].createElement(m,{value:"all"},"全部"),n["default"].createElement(m,{value:"0"},"新建"),n["default"].createElement(m,{value:"1"},"等待执行"),n["default"].createElement(m,{value:"2"},"发送任务失败"),n["default"].createElement(m,{value:"3"},"等待继续执行"),n["default"].createElement(m,{value:"4"},"执行完成"),n["default"].createElement(m,{value:"5"},"执行失败"),n["default"].createElement(m,{value:"6"},"已删除"),n["default"].createElement(m,{value:"7"},"已终止")))),n["default"].createElement(l.Col,{span:"8",className:t.showDate?"show":"hidden"},n["default"].createElement(l.Col,{span:"12"},n["default"].createElement(l.DatePicker,{onChange:this.getStartTime,disabledDate:a})),n["default"].createElement(l.Col,{span:"12"},n["default"].createElement(l.DatePicker,{onChange:this.getEndTime,disabledDate:a}))),n["default"].createElement(l.Col,{span:"4"},n["default"].createElement(l.Button,{type:"primary",onClick:this.request},"查询")))))},onSelectChange:function(e){this.setState({select:e})},onStatusChange:function(e){this.setState({status:e})},request:function(e){"mine"==e?this.props.request(e):(this.props.requestData(this.requestData()),this.props.request())},getStartTime:function(e){this.setState({starttime:Math.round(e.getTime()/1e3)-86400-1})},getEndTime:function(e){this.setState({endtime:Math.round(e.getTime()/1e3)})},chooseSelect:function(e){var t=this.state.show;for(var a in t)t[a]=a==e?!0:!1;this.setState({choose:e}),this.setState({show:{showDate:t.showDate,showSelect:t.showSelect,showExecute:t.showExecute,showAll:t.showAll,showCreate:t.showCreate,showStatus:t.showStatus}})}}),p=n["default"].createClass({displayName:"List",componentWillReceiveProps:function(e){var t=this;if(t.setState({uuapUserName:e.userName}),location.hash.indexOf("orderId")>=0){var a=parseInt(location.hash.split("?")[1].split("&")[0].split("=")[1],10);this.props.changeActivityTab(),this.enterDetail(a)}else var a="";t.request("mine",e.userName)},getInitialState:function(){return{result:{},requestData:{},uuapUserName:""}},componentDidMount:function(){if(location.hash.indexOf("orderId")>=0){var e=parseInt(location.hash.split("?")[1].split("&")[0].split("=")[1],10);this.props.changeActivityTab(),this.enterDetail(e)}else var e="";this.request("mine")},request:function(e,t){if(t||this.state.uuapUserName){var a=this;i["default"]({type:"JSON",url:"/v1/order/list",headers:{"UUAP-USERNAME":t||a.state.uuapUserName},data:"mine"==e?{type:"mine"}:a.Data}).then(function(e){if(200==e.status){var t=JSON.parse(e.response);0==t.errno&&a.setState({result:t})}})}},render:function(){var e=this.state.result&&this.state.result.data||[],t=this.columns(),a={total:e.length,showSizeChanger:!0};return n["default"].createElement("div",null,n["default"].createElement(f,{requestData:this.requestData,activeKey:this.props.activeKey,request:this.request}),n["default"].createElement(l.Table,{columns:t,dataSource:e,pagination:a}))},columns:function E(){var e=this,E=[{title:"ID",dataIndex:"orderId",render:function(t,a){return t?n["default"].createElement("a",{onClick:function(){e.enterDetail(a.orderId)}},t):"-"}},{title:"名称",dataIndex:"orderName"},{title:"创建者",dataIndex:"userName",render:function(e,t){return t.userName&&"null"!=t.userName?t.userName:"-"}},{title:"执行者",dataIndex:"operationUserName",render:function(e,t){return""==t.operationUserName||"null"==t.operationUserName?"-":t.operationUserName}},{title:"创建时间",dataIndex:"createTime",render:function(e,t){return 0==t.createTime?"-":d["default"].dateFormat(new Date(1e3*t.createTime),"yyyy-MM-dd hh:mm:ss")}},{title:"完成时间",dataIndex:"endTime",render:function(e,t){return 0==t.endTime?"-":d["default"].dateFormat(new Date(1e3*t.endTime),"yyyy-MM-dd hh:mm:ss")}},{title:"上线时间",dataIndex:"startTime",render:function(e,t){return 0==t.startTime?"-":d["default"].dateFormat(new Date(1e3*t.startTime),"yyyy-MM-dd hh:mm:ss")}},{title:"状态",dataIndex:"status",render:function(e,t){var a=t.status;switch(a){case 0:a="新建";break;case 1:a="等待执行";break;case 2:a="发送任务失败";break;case 3:a="等待继续执行";break;case 4:a="执行完成";break;case 5:a="已删除";break;case 6:a="失败";break;case 7:a="已终止";break;default:a="-"}return a}},{title:"类型",dataIndex:"orderType",render:function(e){return 0==e?"上线单":"回滚单"}},{title:"操作",dataIndex:"address",render:function(t,a){var s=0==a.status&&1!=a.contentType?!1:!0,r=1!=a.contentType?!1:!0;return n["default"].createElement("div",null,n["default"].createElement(l.Button,{type:"primary",size:"small",onClick:function(){e.deleteOrder(a.orderId)},disabled:s},"删除"),n["default"].createElement(l.Button,{type:"primary",size:"small",onClick:function(){e.forceFinish(a.orderId,a.status)},disabled:r},"回滚"),n["default"].createElement(l.Button,{type:"primary",size:"small",onClick:function(){e.enterDetail(a.orderId)}},"详情"))}}];return E},enterDetail:function(e){window.isOnce=!1,this.props.showDetail(!0),location.hash="online/detail?orderId="+e,this.props.changeActivityTab(),location.reload()},forceFinish:function(e,t){var a=this;return 3==t||4==t?void a.rollback(e):void i["default"]({type:"JSON",url:"/v1/order/forceFinish",headers:{"UUAP-USERNAME":a.props.userName},data:{orderId:e}}).then(function(t){if(200==t.status){var s=JSON.parse(t.response);0==s.errno?a.rollback(e):l.message.error("回滚单创建失败  "+h["default"](s.errno),4)}})},rollback:function(e){var t=this.state.result,a=t.data.filter(function(t){return t.orderId==e}),s=this,r={OrderName:a[0].orderName,OrderType:1,ModuleName:a[0].moduleName,ModuleVersion:a[0].moduleLastVersion,HookBefore:a[0].hookBefore,HookAfter:a[0].hookAfter};i["default"]({type:"JSON",url:"/v1/order/commit",method:"post",headers:{"UUAP-USERNAME":s.props.userName},data:JSON.stringify({data:r})}).then(function(e){if(200==e.status){var t=JSON.parse(e.response);0==t.errno?(l.message.success("回滚单创建完成",3),s.props.showDetail(!0),location.hash="online/detail?orderId="+t.data.Id,s.props.changeActivityTab()):l.message.error("回滚单创建失败  "+h["default"](t.errno),4)}})},deleteOrder:function(e){var t=this;i["default"]({type:"JSON",url:"/v1/order/delete",headers:{"UUAP-USERNAME":t.props.userName},method:"post",data:JSON.stringify({data:{orderId:e}})}).then(function(e){if(200==e.status){var a=JSON.parse(e.response);0==a.errno?(l.message.success("删除成功",3),t.request()):l.message.error("删除失败  "+h["default"](a.errno),4),t.setState({choose:"mine"}),t.request()}})},requestData:function(e){this.Data=e}});t["default"]=p,a.exports=t["default"]});