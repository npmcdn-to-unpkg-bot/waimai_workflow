define("ops:widget/online/detail.jsx",function(e,t,a){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var n=e("react"),r=s(n),l=e("antd"),o=e("ops:widget/online/modal.jsx"),i=s(o),c=e("reqwest"),u=s(c),d=e("ops:static/js/utils/utils.js"),m=s(d),f=e("ops:widget/online/errno.js"),p=s(f),h=(l.Form.Item,l.Steps.Step),E=r["default"].createClass({displayName:"Info",getInitialState:function(){return{isShowKey:!1}},componentWillReceiveProps:function(){this.render()},render:function(){var e=this.props.basicInfo;return r["default"].createElement("div",{className:"info clearfix"},r["default"].createElement(l.Col,{span:"12"},r["default"].createElement(l.Row,null,r["default"].createElement(l.Col,{span:"23",className:"title"},r["default"].createElement("h2",null,"基本信息"))),r["default"].createElement(l.Col,{span:"12"},r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"ID："),r["default"].createElement(l.Col,{span:"17"},e.orderId)),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"类型："),r["default"].createElement(l.Col,{span:"17"},0==e.orderType?"上线单":"回滚单")),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"创建者："),r["default"].createElement(l.Col,{span:"17"},""==e.orderCreateUserName?"暂无":e.orderCreateUserName)),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"状态："),r["default"].createElement(l.Col,{span:"17"},this.getStatus(e.orderStatus))),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"结束时间："),r["default"].createElement(l.Col,{span:"17"},0==e.orderEndTime?"暂无":m["default"].dateFormat(new Date(1e3*e.orderEndTime),"yyyy-MM-dd hh:mm:ss"))),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"前置命令："),r["default"].createElement(l.Col,{span:"17"},""==e.hookBefore?"暂无":e.hookBefore))),r["default"].createElement(l.Col,{span:"12"},r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"名称："),r["default"].createElement(l.Col,{span:"17"},e.orderName)),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"上线内容："),r["default"].createElement(l.Col,{span:"17"},0==e.orderContentType?"代码上线":"配置文件上线")),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"执行者："),r["default"].createElement(l.Col,{span:"17"},""==e.orderOperationUserName?"暂无":e.orderOperationUserName)),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"创建时间："),r["default"].createElement(l.Col,{span:"17"},m["default"].dateFormat(new Date(1e3*e.orderCreateTime),"yyyy-MM-dd hh:mm:ss"))),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"后置命令："),r["default"].createElement(l.Col,{span:"17"},""==e.hookAfter?"暂无":e.hookAfter)))),r["default"].createElement(l.Col,{span:"12"},r["default"].createElement(l.Row,{style:{marginLeft:"20px"}},r["default"].createElement(l.Col,{span:"23",className:"title"},r["default"].createElement("h2",null,"模块信息"))),r["default"].createElement(l.Col,{span:"12",className:"padding_right partline"},r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"模块名称："),r["default"].createElement(l.Col,{span:"17"},e.moduleName)),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"路径："),r["default"].createElement(l.Col,{span:"17"},e.modulePath)),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"稳定版本："),r["default"].createElement(l.Col,{span:"17"},""==e.lastVersion?"暂无":e.lastVersion)),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"8",className:"right"},"待上线版本："),r["default"].createElement(l.Col,{span:"16"},""==e.moduleVersion?"暂无":e.moduleVersion)),r["default"].createElement(l.Row,{className:"item"},r["default"].createElement(l.Col,{span:"7",className:"right"},"BNS列表："),r["default"].createElement(l.Col,{span:"17"},this.getBns(e))),r["default"].createElement(l.Row,{className:"item"},"0.0.0.0"==e.lastVersion||""==e.lastVersion?r["default"].createElement(l.Button,{type:"primary",size:"large",onClick:this.openKey},"解锁"):""))))},openKey:function(){var e=this,t=this.props.orderId;u["default"]({type:"JSON",url:"/v1/order/forceFinish",headers:{"UUAP-USERNAME":e.props.userName},data:{orderId:t}}).then(function(t){if(200==t.status){var a=JSON.parse(t.response);0==a.errno?(e.setState({isShowKey:!1}),l.message.success("解锁成功",3)):l.message.error("解锁失败  "+p["default"](a.errno),4)}})},getBns:function(e){if(e.bnsInfo){var t=e.bnsInfo,a=[];return t.map(function(e,t){a.push(r["default"].createElement(l.Col,{key:t},e))}),a}},getStatus:function(e){switch(e){case 0:e="新建";break;case 1:e="等待执行";break;case 2:e="发送任务失败";break;case 3:e="等待继续执行";break;case 4:e="执行完成";break;case 5:e="已删除";break;case 6:e="失败";break;case 7:e="已终止";break;default:e="-"}return e}}),N=r["default"].createClass({displayName:"Online",componentWillReceiveProps:function(){if(location.hash.indexOf("orderId")>=0)var e=parseInt(location.hash.split("?")[1].split("&")[0].split("=")[1],10);else var e="";this.checkStatus("mirror",e)},getInitialState:function(){return{isShowDetail:!1,onlineState:{start:[0,""],mirror:[0,""],stop:[0,""],all:[0,""]},step:"",stepNum:0,mirrorInfo:{},stopInfo:{},allInfo:{},modalInfo:{}}},changeNext:function(e){"mirror"==e?this.changeStep("stop"):"stop"==e?this.changeStep("all"):"all"==e&&this.setState({stepNum:4})},changePre:function(e){window.isOnce||("mirror"==e||"start"==e?(this.changeStep("start"),window.isOnce=!0):"stop"==e?(this.changeStep("mirror"),window.isOnce=!0):"all"==e&&(this.changeStep("stop"),window.isOnce=!0))},checkStatus:function(e,t){var a=this;a.orderId=t,(t||a.props.userName)&&u["default"]({type:"JSON",url:"/v1/order/pauseStatus",headers:{"UUAP-USERNAME":a.props.userName},data:{orderId:t,type:e}}).then(function(t){if(200==t.status){var s=JSON.parse(t.response);0==s.errno?(a.saveInfo(e,s),a.onChangeModalInfo(s.data.data),"mirror"==e?a.checkStatus("stop",a.orderId):"stop"==e&&a.checkStatus("all",a.orderId),"DOING"!=s.data.result&&("SUCCESS"==s.data.result?("mirror"==e&&a.showSuccess("start"),a.showSuccess(e),a.changeNext(e)):"WAITING"==s.data.result?("mirror"==e&&(a.showWait("start"),a.changePre("start")),a.showWait(e),a.changePre(e)):"FAIL"==s.data.result&&("mirror"==e&&a.showSuccess("start"),a.showFail(e,s.errno)))):("mirror"==e&&a.showSuccess("start"),a.showFail(e,s.errno))}})},saveInfo:function(e,t){var a=this;"mirror"==e?a.setState({mirrorInfo:t.data.data}):"stop"==e?a.setState({stopInfo:t.data.data}):"all"==e&&a.setState({allInfo:t.data.data})},render:function(){var e=this,t=this.state.onlineState,a=0==this.state.stepNum?!1:!0,s=(1==this.state.stepNum?!1:!0,2==this.state.stepNum?!1:!0),n=3==this.state.stepNum?!1:!0,o=4==this.props.basicInfo.orderStatus||5==this.props.basicInfo.orderStatus?!0:!1,c=[{title:"任务提交"},{title:"mirror"},{title:"暂停点"},{title:"全量"}].map(function(e,t){return r["default"].createElement(h,{key:t,title:e.title,description:e.description})});return r["default"].createElement("div",{className:this.props.className+" online"},r["default"].createElement(l.Row,{className:"head"},r["default"].createElement(l.Col,{span:"6"},"上线步骤"),r["default"].createElement(l.Col,{span:"6"},"状态"),r["default"].createElement(l.Col,{span:"6"},"操作"),r["default"].createElement(l.Col,{span:"6"},"原因")),r["default"].createElement(l.Row,{className:"grid"},r["default"].createElement(l.Col,{span:"6",className:"pad"},r["default"].createElement(l.Steps,{direction:"vertical",current:this.state.stepNum},c)),r["default"].createElement(l.Col,{span:"6"},r["default"].createElement(l.Row,{className:"content"},this.onState(t.start)),r["default"].createElement(l.Row,{className:"content"},this.onState(t.mirror)),r["default"].createElement(l.Row,{className:"content"},this.onState(t.stop)),r["default"].createElement(l.Row,{className:"content"},this.onState(t.all))),r["default"].createElement(l.Col,{span:"6"},r["default"].createElement(l.Row,{className:"content"},r["default"].createElement(l.Button,{ref:"start",disabled:a,type:"primary",size:"small",onClick:function(){e.onStart("start")}},"上线"),r["default"].createElement(l.Button,{type:"primary",size:"small",onClick:function(){e.onStart("start")},disabled:o},"重做")),r["default"].createElement(l.Row,{className:"content"},r["default"].createElement(l.Button,{type:"primary",size:"small",value:"1",onClick:function(){e.onShowDetail(e.state.mirrorInfo)}},"详情"),r["default"].createElement(l.Button,{type:"primary",size:"small",onClick:function(){e.onContinue("mirror")},disabled:o},"重做")),r["default"].createElement(l.Row,{className:"content"},r["default"].createElement(l.Button,{type:"primary",size:"small",value:"1",onClick:function(){e.onShowDetail(e.state.stopInfo)}},"详情"),r["default"].createElement(l.Button,{ref:"stop",disabled:s,type:"primary",size:"small",onClick:function(){e.onContinue("stop")}},"继续"),r["default"].createElement(l.Button,{type:"primary",size:"small",onClick:function(){e.onContinue("stop")},disabled:o},"重做")),r["default"].createElement(l.Row,{className:"content"},r["default"].createElement(l.Button,{type:"primary",size:"small",value:"1",onClick:function(){e.onShowDetail(e.state.allInfo)}},"详情"),r["default"].createElement(l.Button,{ref:"all",disabled:n,type:"primary",size:"small",onClick:function(){e.onContinue("all")}},"继续"),r["default"].createElement(l.Button,{type:"primary",size:"small",onClick:function(){e.onContinue("all")},disabled:o},"重做"))),r["default"].createElement(l.Col,{span:"6"},r["default"].createElement(l.Row,{className:"content"},this.onErrorMsg(t.start)),r["default"].createElement(l.Row,{className:"content"},this.onErrorMsg(t.mirror)),r["default"].createElement(l.Row,{className:"content"},this.onErrorMsg(t.stop)),r["default"].createElement(l.Row,{className:"content"},this.onErrorMsg(t.all)))),r["default"].createElement(i["default"],{isShow:this.state.isShowDetail,changeState:this.changeState,modalInfo:this.state.modalInfo}))},onState:function(e){var t=e[0],a=["待开始",r["default"].createElement(l.Icon,{type:"loading"}),"成功","失败"];return a[t]},onErrorMsg:function(e){var t=e[1];return 0!=t?p["default"](t):""},changeStep:function(e){var t=this;switch(e){case"start":t.setState({step:"start",stepNum:0});break;case"mirror":t.setState({step:"mirror",stepNum:1});break;case"stop":t.setState({step:"stop",stepNum:2});break;case"all":t.setState({step:"all",stepNum:3});break;case"end":t.setState({step:"end",stepNum:4})}},lunxunRequest:function(e){var t=this,a=this.props.orderId;u["default"]({type:"JSON",url:"/v1/order/pauseStatus",headers:{"UUAP-USERNAME":t.props.userName},data:{orderId:a,type:e}}).then(function(a){if(200==a.status){var s=JSON.parse(a.response);0==s.errno?(t.setState({lunxunInfo:s.data.data}),t.saveInfo(e,s),t.onChangeModalInfo(s.data.data),"DOING"!=s.data.result&&("SUCCESS"==s.data.result?(t.showSuccess(e),t.changeNext(e)):"WAITING"==s.data.result?t.showWait(e):t.showFail(e,s.errno),clearInterval(window.interval))):(clearInterval(window.interval),t.showFail(e,s.errno))}})},lunXun:function(e){var t=this;this.changeStep(e),this.showLoading(e),this.changeNext(e),window.interval=setInterval(function(){t.lunxunRequest(e)},1e4)},onContinue:function(e){var t=this,a=this.props.orderId;t.showLoading(e),u["default"]({type:"JSON",url:"/v1/order/continue",headers:{"UUAP-USERNAME":t.props.userName},data:{orderId:a,type:e}}).then(function(a){if(200==a.status){var s=JSON.parse(a.response);0==s.errno?t.lunXun(e):t.showFail(e,s.errno)}else t.showFail(e,s.errno)})},onStart:function(e){var t=this;this.changeStep(e),this.showLoading(e),u["default"]({type:"JSON",url:"/v1/order/start",method:"post",headers:{"UUAP-USERNAME":t.props.userName},data:JSON.stringify({data:{orderId:t.props.orderId}})}).then(function(a){if(200==a.status){var s=JSON.parse(a.response);0==s.errno?(t.showSuccess(e),t.changeStep("mirror"),t.lunXun("mirror")):429==s.errno?(t.showFail(e,"no"),l.message.error(s.data+"上线单正在对"+t.props.basicInfo.moduleName+"模块上线",4)):432==s.errno?(t.showFail(e,"no"),l.message.error("不在"+s.data+"上线时间范围内",4)):t.showFail(e,s.errno)}else t.showFail(e,s.errno)})},showFail:function(e,t){this.changeStep(e);{var a=this.state.onlineState;this.state.step}a[e][0]=3,a[e][1]=t,this.setOnlineState(a)},setOnlineState:function(e){this.setState({onlineState:e})},showWait:function(e){var t=this.state.onlineState;t[e][0]=0,t[e][1]="no",this.setOnlineState(t)},showSuccess:function(e){this.changeStep(e);var t=(this.state.step,this.state.onlineState);t[e][0]=2,t[e][1]="no",this.setOnlineState(t)},showLoading:function(e){this.changeStep(e);{var t=this.state.onlineState;this.state.step}t[e][0]=1,t[e][1]="no",this.setOnlineState(t)},onShowDetail:function(e){this.setState({isShowDetail:!0,modalInfo:e})},onChangeModalInfo:function(e){this.setState({modalInfo:e})},changeState:function(e){this.setState({isShowDetail:e})}}),S=r["default"].createClass({displayName:"Detail",componentWillReceiveProps:function(e){var t=this;if(t.setState({uuapUserName:e.userName}),location.hash.indexOf("orderId")>=0)var a=parseInt(location.hash.split("?")[1].split("&")[0].split("=")[1],10);else var a="";this.request(a,e.userName)},getInitialState:function(){if(location.hash.indexOf("orderId")>=0)var e=parseInt(location.hash.split("?")[1].split("&")[0].split("=")[1],10);else var e="";return{info:{},orderId:e,uuapUserName:""}},componentWillMount:function(){location.reload(),this.request()},request:function(e,t){var a=this;if(t||this.state.uuapUserName){var e=e||this.state.orderId;u["default"]({type:"JSON",url:"/v1/order/detail",headers:{"UUAP-USERNAME":t||a.state.uuapUserName},data:{orderId:e}}).then(function(t){if(200==t.status){var s=JSON.parse(t.response);0==s.errno&&a.setState({info:s.data,orderId:e})}})}},render:function(){var e=this.state.orderId,t=this.state.info;return r["default"].createElement("div",{className:"detail"},r["default"].createElement(E,{orderId:e,basicInfo:t,userName:this.state.uuapUserName}),r["default"].createElement(N,{orderId:e,basicInfo:t,userName:this.state.uuapUserName,className:5==t.orderStatus?"hidden":"show"}))},showModal:function(){}});t["default"]=S,a.exports=t["default"]});